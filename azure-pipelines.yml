trigger: none

parameters:
- name: awsServiceConnection
  type: string
  default: "SAMCObservability-492046385895-DEVOPSIACSVCVPC-Infrastructure Operations"

- name: awsRegion
  type: string
  default: "us-east-1"
  values:
    - "us-east-1"
    - "us-east-2"

- name: moduleRef
  type: string
  default: "refs/tags/4.2.0"

- name: tfvarsFile
  type: string
  default: "dev.tfvars"

- name: tfPlanOnly
  type: boolean
  default: true

pool:
  vmImage: "ubuntu-latest"

stages:
- stage: s3
  displayName: "Deploy S3 module (Method B)"
  jobs:
  - job: terraform
    displayName: "Terraform (init/plan/apply)"
    steps:
      - script: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y unzip jq
          TFV="1.12.2"
          curl -sSLo /tmp/terraform_${TFV}_linux_amd64.zip "https://releases.hashicorp.com/terraform/${TFV}/terraform_${TFV}_linux_amd64.zip"
          sudo unzip -o /tmp/terraform_${TFV}_linux_amd64.zip -d /usr/local/bin
          terraform -version
          jq --version
        displayName: "Install Terraform 1.12.2 + jq"

      - task: AWSShellScript@1
        displayName: "Terraform init/plan/apply (AWS creds)"
        inputs:
          awsCredentials: ${{ parameters.awsServiceConnection }}
          regionName: ${{ parameters.awsRegion }}
          scriptType: "inline"
          inlineScript: |
            set -euo pipefail

            echo "Configure ADO bearer header so terraform can fetch cross-project module..."
            git config --global http.https://dev.azure.com.extraheader "AUTHORIZATION: bearer ${SYSTEM_ACCESSTOKEN}"

            echo "Sanity: list remote of shared module repo (should succeed)"
            git ls-remote "https://dev.azure.com/samcado/Infrastructure%20Operations/_git/DEVOPS_Platform_as_a_Service/s3" >/dev/null

            cd infra

            echo "terraform init (moduleRef=${MODULE_REF})"
            terraform init -input=false

            echo "terraform validate"
            terraform validate

            echo "terraform plan (-var-file=${TFVARS_FILE})"
            terraform plan -input=false \
              -var "module_ref=${MODULE_REF}" \
              -var-file="${TFVARS_FILE}"

            if [ "${TF_PLAN_ONLY}" = "false" ]; then
              echo "terraform apply"
              terraform apply -input=false -auto-approve \
                -var "module_ref=${MODULE_REF}" \
                -var-file="${TFVARS_FILE}"
            else
              echo "Plan-only mode active; skipping apply."
            fi
        env:
          SYSTEM_ACCESSTOKEN: $(System.AccessToken)
          MODULE_REF: ${{ parameters.moduleRef }}
          TFVARS_FILE: ${{ parameters.tfvarsFile }}
          TF_PLAN_ONLY: ${{ parameters.tfPlanOnly }}
