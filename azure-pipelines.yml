# azure-pipelines.yml
trigger: none

pool:
  vmImage: ubuntu-latest

variables:
  TF_VERSION: '1.7.5'
  ADO_ORG: 'samcado'
  ADO_PROJECT: 'DEVOPS_Platform_as_a_Service'
  MODULE_TAG: 'refs/tags/4.2.0'
  MODULE_PATH: 'terraform-3.1.0-s3-bucket'
  MODULE_URL: 'git::https://$(ADO_ORG).visualstudio.com/$(ADO_PROJECT)/_git/s3//$(MODULE_PATH)?ref=$(MODULE_TAG)'

steps:
  - checkout: self

  - script: |
      set -eux
      umask 077
      cat > ~/.netrc << 'EOF'
      machine $(ADO_ORG).visualstudio.com
        login AzureDevOps
        password $(S3_PAT)
      machine dev.azure.com
        login AzureDevOps
        password $(S3_PAT)
      EOF

      git config --global credential.helper store
    displayName: "Seed ~/.netrc with PAT for Git HTTPS"
    env:
      S3_PAT: $(S3_PAT)   # secret var

  - script: |
      set -eux
      curl -sSLo tf.zip https://releases.hashicorp.com/terraform/$(TF_VERSION)/terraform_$(TF_VERSION)_linux_amd64.zip
      sudo unzip -o tf.zip -d /usr/local/bin
      terraform -version
    displayName: "Install Terraform"

  - script: |
      set -eux
      terraform init -input=false
      terraform validate
      terraform plan -input=false -var-file="dev.tfvars"
    env:
      TF_LOG: WARN
    displayName: "Terraform init/plan (module via Git URL + PAT)"
