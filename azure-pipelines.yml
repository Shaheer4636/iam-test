# ecr/deploy-ecr.yml
# Uses the shared deploy template, but the checkout steps come from ecr/gitCheckouts.yml in THIS repo.

resources:
  repositories:
    - repository: templates
      type: git
      name: DEVOPS_Platform_as_a_Service/deploy-templates
      ref: refs/tags/7.7.0

    # ECR module repo â€” alias must be AWS-ECR (used by gitCheckouts.yml)
    - repository: AWS-ECR
      type: git
      name: DEVOPS_Platform_as_a_Service/AWS-ECR
      ref: refs/tags/1.0.0

    # Declared because the shared jobs often expect it; harmless to checkout
    - repository: iam-controls
      type: git
      name: DEVOPS_Platform_as_a_Service/iam-controls
      ref: refs/tags/2.16.0

trigger: none

parameters:
- name: sandbox
  displayName: Deploy ECR to SAMC
  type: boolean
  default: true
- name: terrformPLANonly
  displayName: tfPlanOnly (check == true)
  type: boolean
  default: false

stages:
- template: deploy/tf-create-infra-template.yml@templates
  parameters:
    environment: sandbox
    environmentDisplayName: sandbox
    tfServiceConnection: SAMCObservability-492046385895-DEVOPSIACSVCVPC-us-east-1-Infrastructure Operations
    awsServiceConnection: SAMCObservability-492046385895-DEVOPSIACSVCVPC-Infrastructure Operations
    tfVersion: 1.13.3
    reqS3Mod: false                     # ECR-only
    application: ClientUptime
    pipelineSrcDir: ecr                 # run Terraform from the ecr/ folder
    tfPlanOnly: ${{ parameters.terrformPLANonly }}
    regionName: us-east-1

    # IMPORTANT: use the checkout file in YOUR repo (qualify with @self and include the subfolder)
    checkoutTemplate: ecr/gitCheckouts.yml@self
