# azure-pipelines.yml
trigger: none

# (Optional) repo reference so Azure can pre-authorize cross-project access
resources:
  repositories:
    - repository: s3mod
      type: git
      name: DEVOPS_Platform_as_a_Service/s3
      ref: refs/tags/4.2.0

parameters:
- name: awsServiceConnection
  type: string
  default: "SAMCObservability-492046385895-DEVOPSIACSVCVPC-Infrastructure Operations"

- name: awsRegion
  type: string
  default: "us-east-1"
  values:
    - "us-east-1"
    - "us-east-2"

- name: tfPlanOnly
  type: boolean
  default: true

- name: adoPat
  type: string
  default: ""     # PAT with Code:Read on DEVOPS_Platform_as_a_Service

# "auto" will scan for the first folder containing *.tf; set an explicit path if you prefer
- name: tfWorkingDir
  type: string
  default: "auto"

pool:
  vmImage: ubuntu-latest

stages:
- stage: s3
  displayName: Deploy S3 module (visualstudio.com + S3 backend)
  jobs:
  - job: terraform
    displayName: Terraform init/plan/apply
    steps:
      - checkout: self
      - checkout: s3mod
        path: _authorized_s3_repo

      - script: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y unzip jq
          TFV="1.12.2"
          curl -sSLo /tmp/terraform_${TFV}_linux_amd64.zip "https://releases.hashicorp.com/terraform/${TFV}/terraform_${TFV}_linux_amd64.zip"
          sudo unzip -o /tmp/terraform_${TFV}_linux_amd64.zip -d /usr/local/bin
          terraform -version
          jq --version
          echo "Sources: $(Build.SourcesDirectory)"
          echo "Repo:    $(Build.Repository.Name)"
        displayName: Install Terraform + tools

      - task: AWSShellScript@1
        displayName: Terraform init/plan/apply (AWS creds)
        inputs:
          awsCredentials: ${{ parameters.awsServiceConnection }}
          regionName: ${{ parameters.awsRegion }}
          scriptType: inline
          inlineScript: |
            set -euo pipefail
            export TF_IN_AUTOMATION=1
            export GIT_TERMINAL_PROMPT=0

            # --- Auth for ADO Git using PAT via ~/.netrc (non-interactive) ---
            if [ -n "${ADO_PAT:-}" ]; then
              umask 077
              cat > ~/.netrc <<EOF
machine samcado.visualstudio.com
  login pat
  password ${ADO_PAT}
machine dev.azure.com
  login pat
  password ${ADO_PAT}
EOF
            fi
            # -----------------------------------------------------------------

            echo "Sanity: cross-project repo access"
            git ls-remote "https://samcado.visualstudio.com/DEVOPS_Platform_as_a_Service/_git/s3" >/dev/null

            BASE="$(Build.SourcesDirectory)"
            REPO="$(Build.Repository.Name)"
            if [ -d "$BASE/$REPO" ]; then
              ROOT="$BASE/$REPO"
            else
              ROOT="$BASE"
            fi
            echo "Detected root: $ROOT"

            # Resolve working dir
            if [ "${TF_WORKING_DIR}" = "auto" ]; then
              TF_DIR="$(find "$ROOT" -maxdepth 4 -type f -name '*.tf' -printf '%h\n' | sort -u | head -n 1 || true)"
              if [ -z "$TF_DIR" ]; then
                echo "ERROR: No Terraform files (*.tf) found under $ROOT"
                exit 51
              fi
            else
              TF_DIR="$ROOT/${TF_WORKING_DIR}"
            fi
            echo "Using Terraform working dir: $TF_DIR"
            ls -la "$TF_DIR"

            # Ensure backend.hcl exists (your bucket)
            if [ ! -f "$TF_DIR/backend.hcl" ]; then
              cat > "$TF_DIR/backend.hcl" <<'HCL'
bucket = "testdemobackend03096174636"
key    = "client-uptime-report-obs/terraform.tfstate"
region = "us-east-1"
HCL
            fi

            cd "$TF_DIR"

            echo "terraform init (S3 backend)"
            terraform init -input=false -backend-config=backend.hcl -reconfigure

            echo "terraform validate"
            terraform validate

            # Use dev.tfvars if present
            if [ -f "dev.tfvars" ]; then
              echo "terraform plan (dev.tfvars)"
              terraform plan -input=false -var-file="dev.tfvars"
            else
              echo "terraform plan (no tfvars)"
              terraform plan -input=false
            fi

            if [ "${TF_PLAN_ONLY}" = "false" ]; then
              if [ -f "dev.tfvars" ]; then
                terraform apply -input=false -auto-approve -var-file="dev.tfvars"
              else
                terraform apply -input=false -auto-approve
              fi
            else
              echo "Plan-only mode active; skipping apply."
            fi
        env:
          ADO_PAT: ${{ parameters.adoPat }}
          TF_PLAN_ONLY: ${{ parameters.tfPlanOnly }}
          TF_WORKING_DIR: ${{ parameters.tfWorkingDir }}
